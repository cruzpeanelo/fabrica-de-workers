// Accessibility Helpers
(function(global){"use strict";const A11y={state:{isKeyboardUser:false,previousFocus:null,activeFocusTrap:null,announcer:null,modals:new Map(),tabs:new Map()},
init(){this.setupKeyboardDetection();this.setupAnnouncer();this.setupSkipLinks();this.setupModals();this.setupTabs();this.detectPreferences();this.setupFormValidation();console.log("[A11y] Initialized");return this;},
setupKeyboardDetection(){document.addEventListener("keydown",(e)=>{if(e.key==="Tab"){this.state.isKeyboardUser=true;document.body.classList.add("keyboard-user");document.body.classList.remove("mouse-user");}});document.addEventListener("mousedown",()=>{this.state.isKeyboardUser=false;document.body.classList.add("mouse-user");document.body.classList.remove("keyboard-user");});document.body.classList.add("mouse-user");},
isKeyboardUser(){return this.state.isKeyboardUser;},
setupAnnouncer(){let a=document.getElementById("a11y-announcer");if(\!a){a=document.createElement("div");a.id="a11y-announcer";a.setAttribute("aria-live","polite");a.setAttribute("aria-atomic","true");a.className="sr-only";a.style.cssText="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;";document.body.appendChild(a);}this.state.announcer=a;},
announce(msg,priority="polite"){if(\!this.state.announcer)this.setupAnnouncer();const a=this.state.announcer;a.setAttribute("aria-live",priority);a.textContent="";requestAnimationFrame(()=>{a.textContent=msg;});},
announceAssertive(msg){this.announce(msg,"assertive");},announcePolite(msg){this.announce(msg,"polite");},
focus(el,opts={}){const e=typeof el==="string"?document.querySelector(el):el;if(\!e){console.warn("[A11y] Element not found");return;}if(opts.savePrevious)this.state.previousFocus=document.activeElement;if(\!e.hasAttribute("tabindex"))e.setAttribute("tabindex","-1");e.focus({preventScroll:opts.preventScroll||false});if(opts.announce)this.announce(opts.announce);},
restoreFocus(){if(this.state.previousFocus&&typeof this.state.previousFocus.focus==="function"){this.state.previousFocus.focus();this.state.previousFocus=null;}},
focusFirst(c){const e=typeof c==="string"?document.querySelector(c):c;if(\!e)return;const f=this.getFocusableElements(e);if(f.length>0)f[0].focus();},
focusLast(c){const e=typeof c==="string"?document.querySelector(c):c;if(\!e)return;const f=this.getFocusableElements(e);if(f.length>0)f[f.length-1].focus();},
getFocusableElements(c){const s="a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex=\"-1\"]),[contenteditable],audio[controls],video[controls],details>summary";return Array.from(c.querySelectorAll(s)).filter(e=>{const st=window.getComputedStyle(e);return st.display\!=="none"&&st.visibility\!=="hidden"&&e.offsetParent\!==null;});},
createFocusTrap(c){const e=typeof c==="string"?document.querySelector(c):c;if(\!e){console.warn("[A11y] Container not found");return null;}const self=this;const t={container:e,active:false,previousFocus:null,activate:function(){t.previousFocus=document.activeElement;t.active=true;document.addEventListener("keydown",t.handleKeydown);self.focusFirst(e);self.state.activeFocusTrap=t;},deactivate:function(){t.active=false;document.removeEventListener("keydown",t.handleKeydown);if(t.previousFocus&&typeof t.previousFocus.focus==="function")t.previousFocus.focus();if(self.state.activeFocusTrap===t)self.state.activeFocusTrap=null;},handleKeydown:function(ev){if(\!t.active||ev.key\!=="Tab")return;const f=self.getFocusableElements(e);if(f.length===0)return;const first=f[0],last=f[f.length-1];if(ev.shiftKey){if(document.activeElement===first){ev.preventDefault();last.focus();}}else{if(document.activeElement===last){ev.preventDefault();first.focus();}}}};return t;},
setupSkipLinks(){const self=this;document.querySelectorAll(".skip-link,[data-skip-link]").forEach(l=>{l.addEventListener("click",(ev)=>{const tid=l.getAttribute("href").substring(1);const t=document.getElementById(tid);if(t){ev.preventDefault();self.focus(t,{announce:"Navigated to "+(t.getAttribute("aria-label")||tid)});}});});},
setupModals(){const self=this;document.querySelectorAll("[role=dialog],.modal,[data-modal]").forEach(m=>{const id=m.id||"modal-"+Math.random().toString(36).substr(2,9);m.id=id;const ft=self.createFocusTrap(m);self.state.modals.set(id,{element:m,focusTrap:ft,isOpen:false});});document.querySelectorAll("[data-modal-close],.modal-close").forEach(b=>{b.addEventListener("click",()=>{const m=b.closest("[role=dialog],.modal,[data-modal]");if(m)self.closeModal(m.id);});});document.querySelectorAll("[data-modal-open]").forEach(t=>{t.addEventListener("click",()=>{self.openModal(t.getAttribute("data-modal-open"));});});document.addEventListener("keydown",(ev)=>{if(ev.key==="Escape"){for(const[id,m]of self.state.modals){if(m.isOpen){self.closeModal(id);break;}}}});},
openModal(mid){const md=this.state.modals.get(mid);if(\!md){console.warn("[A11y] Modal "+mid+" not found");return;}const el=md.element,ft=md.focusTrap;this.state.previousFocus=document.activeElement;el.hidden=false;el.classList.add("is-open");el.setAttribute("aria-hidden","false");document.body.style.overflow="hidden";if(ft)ft.activate();md.isOpen=true;const title=el.querySelector("[role=heading],h1,h2,h3,.modal-title");this.announce("Dialog opened: "+(title?title.textContent:"Modal"));},
closeModal(mid){const md=this.state.modals.get(mid);if(\!md||\!md.isOpen)return;const el=md.element,ft=md.focusTrap;if(ft)ft.deactivate();el.hidden=true;el.classList.remove("is-open");el.setAttribute("aria-hidden","true");document.body.style.overflow="";this.restoreFocus();md.isOpen=false;this.announce("Dialog closed");},
setupTabs(){const self=this;document.querySelectorAll("[role=tablist]").forEach(tl=>{const id=tl.id||"tablist-"+Math.random().toString(36).substr(2,9);tl.id=id;const tabs=Array.from(tl.querySelectorAll("[role=tab]"));const panels=tabs.map(t=>{const pid=t.getAttribute("aria-controls");return document.getElementById(pid);}).filter(Boolean);self.state.tabs.set(id,{tablist:tl,tabs:tabs,panels:panels});tl.addEventListener("keydown",(ev)=>{self.handleTabKeydown(ev,tabs);});tabs.forEach((t,i)=>{t.addEventListener("click",()=>{self.activateTab(id,i);});});});},
handleTabKeydown(ev,tabs){const ci=tabs.indexOf(document.activeElement);if(ci===-1)return;let ni;const isV=ev.target.closest("[role=tablist]")?.getAttribute("aria-orientation")==="vertical";const pk=isV?"ArrowUp":"ArrowLeft";const nk=isV?"ArrowDown":"ArrowRight";switch(ev.key){case pk:ev.preventDefault();ni=ci===0?tabs.length-1:ci-1;tabs[ni].focus();break;case nk:ev.preventDefault();ni=ci===tabs.length-1?0:ci+1;tabs[ni].focus();break;case"Home":ev.preventDefault();tabs[0].focus();break;case"End":ev.preventDefault();tabs[tabs.length-1].focus();break;case"Enter":case" ":ev.preventDefault();ev.target.click();break;}},
activateTab(tlid,idx){const td=this.state.tabs.get(tlid);if(\!td)return;const tabs=td.tabs,panels=td.panels;tabs.forEach((t,i)=>{t.setAttribute("aria-selected","false");t.setAttribute("tabindex","-1");if(panels[i]){panels[i].hidden=true;panels[i].setAttribute("aria-hidden","true");}});tabs[idx].setAttribute("aria-selected","true");tabs[idx].setAttribute("tabindex","0");if(panels[idx]){panels[idx].hidden=false;panels[idx].setAttribute("aria-hidden","false");}this.announce(tabs[idx].textContent+" tab selected");},
detectPreferences(){this.detectReducedMotion();this.detectHighContrast();this.detectColorScheme();},
detectReducedMotion(){const p=window.matchMedia("(prefers-reduced-motion:reduce)").matches;if(p)document.documentElement.classList.add("reduce-motion");window.matchMedia("(prefers-reduced-motion:reduce)").addEventListener("change",(e)=>{document.documentElement.classList.toggle("reduce-motion",e.matches);});return p;},
prefersReducedMotion(){return window.matchMedia("(prefers-reduced-motion:reduce)").matches;},
detectHighContrast(){const p=window.matchMedia("(forced-colors:active)").matches||window.matchMedia("(-ms-high-contrast:active)").matches;if(p)document.documentElement.classList.add("high-contrast");window.matchMedia("(forced-colors:active)").addEventListener("change",(e)=>{document.documentElement.classList.toggle("high-contrast",e.matches);});return p;},
prefersHighContrast(){return window.matchMedia("(forced-colors:active)").matches||window.matchMedia("(-ms-high-contrast:active)").matches;},
detectColorScheme(){const d=window.matchMedia("(prefers-color-scheme:dark)").matches;const s=d?"dark":"light";document.documentElement.setAttribute("data-color-scheme",s);window.matchMedia("(prefers-color-scheme:dark)").addEventListener("change",(e)=>{document.documentElement.setAttribute("data-color-scheme",e.matches?"dark":"light");});return s;},
getColorScheme(){return document.documentElement.getAttribute("data-color-scheme")||(window.matchMedia("(prefers-color-scheme:dark)").matches?"dark":"light");},
setupFormValidation(){const self=this;document.querySelectorAll("form[data-validate],.a11y-form").forEach(f=>{f.addEventListener("submit",(ev)=>{if(\!self.validateForm(f))ev.preventDefault();});f.querySelectorAll("input,select,textarea").forEach(fd=>{fd.addEventListener("blur",()=>{self.validateField(fd);});});});},
validateForm(form){const flds=form.querySelectorAll("input,select,textarea");let isValid=true,firstInvalid=null;flds.forEach(f=>{const v=this.validateField(f);if(\!v&&\!firstInvalid)firstInvalid=f;isValid=isValid&&v;});if(\!isValid){if(firstInvalid)firstInvalid.focus();const ec=form.querySelectorAll("[aria-invalid=true]").length;this.announceAssertive("Form has "+ec+" error"+(ec>1?"s":"")+". Please correct them.");}return isValid;},
validateField(f){this.clearFieldError(f);const req=f.hasAttribute("required");const pat=f.getAttribute("pattern");const minL=f.getAttribute("minlength");const maxL=f.getAttribute("maxlength");const typ=f.getAttribute("type");let isV=true,errMsg="";if(req&&\!f.value.trim()){isV=false;errMsg=f.getAttribute("data-error-required")||"This field is required";}else if(pat&&f.value&&\!new RegExp(pat).test(f.value)){isV=false;errMsg=f.getAttribute("data-error-pattern")||"Please match the requested format";}else if(minL&&f.value.length<parseInt(minL)){isV=false;errMsg=f.getAttribute("data-error-minlength")||"Please enter at least "+minL+" characters";}else if(maxL&&f.value.length>parseInt(maxL)){isV=false;errMsg=f.getAttribute("data-error-maxlength")||"Please enter no more than "+maxL+" characters";}else if(typ==="email"&&f.value&&\!this.isValidEmail(f.value)){isV=false;errMsg=f.getAttribute("data-error-email")||"Please enter a valid email address";}if(\!isV)this.setFieldError(f,errMsg);return isV;},
setFieldError(f,msg){f.setAttribute("aria-invalid","true");f.classList.add("is-invalid");const eid=(f.id||f.name)+"-error";let errEl=document.getElementById(eid);if(\!errEl){errEl=document.createElement("div");errEl.id=eid;errEl.className="field-error";errEl.setAttribute("role","alert");f.parentNode.insertBefore(errEl,f.nextSibling);}errEl.textContent=msg;f.setAttribute("aria-describedby",eid);},
clearFieldError(f){f.removeAttribute("aria-invalid");f.classList.remove("is-invalid");const eid=(f.id||f.name)+"-error";const errEl=document.getElementById(eid);if(errEl)errEl.textContent="";},
isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);},
generateId(p){return(p||"a11y")+"-"+Math.random().toString(36).substr(2,9);},
debounce(fn,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>{fn(...a);},w||300);};},
throttle(fn,l){let inT;return function(...a){if(\!inT){fn.apply(this,a);inT=true;setTimeout(()=>inT=false,l||300);}};},
isVisible(el){const s=window.getComputedStyle(el);return s.display\!=="none"&&s.visibility\!=="hidden"&&el.offsetParent\!==null;},
waitForElement(sel,timeout){return new Promise((res,rej)=>{const el=document.querySelector(sel);if(el){res(el);return;}const obs=new MutationObserver((m,o)=>{const e=document.querySelector(sel);if(e){o.disconnect();res(e);}});obs.observe(document.body,{childList:true,subtree:true});setTimeout(()=>{obs.disconnect();rej(new Error("Element "+sel+" not found"));},timeout||5000);});}}; 
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",()=>A11y.init());}else{A11y.init();}global.A11y=A11y;})(typeof window\!=="undefined"?window:this);
