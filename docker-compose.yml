# Fabrica de Agentes v6.5 - Docker Compose
# Complete Development Environment Setup
# Usage: docker-compose up -d
#
# Services:
# - app: FastAPI application (port 9001)
# - postgres: PostgreSQL 16 database (port 5433)
# - redis: Redis 7 for caching and job queue (port 6379)
# - minio: S3-compatible object storage (ports 9000, 9090)
#
# Issue #123 - Setup Local Completo com Docker Compose

services:
  # =============================================================================
  # APP - Fabrica de Agentes Application
  # =============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: fabrica-agentes:latest
    container_name: fabrica-app
    ports:
      - "9001:9001"
    environment:
      # Application
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG

      # Database - Issue #166: senha configurável
      - DATABASE_URL=postgresql://fabrica:${POSTGRES_PASSWORD:-fabrica_db_secret_2024}@postgres:5432/fabrica_db

      # Redis - Issue #165: com autenticação
      - REDIS_URL=redis://:${REDIS_PASSWORD:-fabrica_redis_secret}@redis:6379

      # MinIO (S3) - Issue #164: credenciais configuráveis
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-fabrica_minio_admin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-fabrica_minio_secret_2024}
      - S3_BUCKET=fabrica-uploads
      - S3_USE_SSL=false

      # Claude API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_MODEL=claude-sonnet-4-20250514

      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-secret-key-change-in-production}
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440

      # Feature Flags
      - FEATURE_FLAGS_ENABLED=true
      - FEATURE_FLAGS_ENV=development

      # Workers
      - MIN_WORKERS=1
      - MAX_WORKERS=3
      - DEFAULT_WORKERS=2

      # Dashboard
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=9001
    volumes:
      - ./projects:/app/projects
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    networks:
      - fabrica-network
    labels:
      - "com.fabrica.service=app"
      - "com.fabrica.version=6.5"

  # =============================================================================
  # POSTGRES - Database
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: fabrica-postgres
    environment:
      # Issue #166: Senha configurável via env var
      POSTGRES_USER: fabrica
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fabrica_db_secret_2024}
      POSTGRES_DB: fabrica_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fabrica -d fabrica_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - fabrica-network
    labels:
      - "com.fabrica.service=database"
      - "com.fabrica.backup=daily"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"

  # =============================================================================
  # REDIS - Cache and Job Queue
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: fabrica-redis
    ports:
      - "6379:6379"
    environment:
      # Issue #165: Autenticação obrigatória
      - REDIS_PASSWORD=${REDIS_PASSWORD:-fabrica_redis_secret}
    volumes:
      - redis_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-fabrica_redis_secret}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 511
      --save 900 1
      --save 300 10
      --save 60 10000
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-fabrica_redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - fabrica-network
    labels:
      - "com.fabrica.service=cache"

  # =============================================================================
  # MINIO - S3-Compatible Object Storage
  # =============================================================================
  minio:
    image: minio/minio:latest
    container_name: fabrica-minio
    ports:
      - "9000:9000"  # API
      - "9090:9090"  # Console
    environment:
      # Issue #164: Credenciais seguras via env vars
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-fabrica_minio_admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-fabrica_minio_secret_2024}
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9090
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9090"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - fabrica-network
    labels:
      - "com.fabrica.service=storage"

  # =============================================================================
  # MINIO-INIT - Create default buckets
  # =============================================================================
  minio-init:
    image: minio/mc:latest
    container_name: fabrica-minio-init
    environment:
      # Issue #164: Usar mesmas credenciais do MinIO
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-fabrica_minio_admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-fabrica_minio_secret_2024}
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
        mc mb myminio/fabrica-uploads --ignore-existing;
        mc mb myminio/fabrica-backups --ignore-existing;
        mc mb myminio/fabrica-exports --ignore-existing;
        mc anonymous set download myminio/fabrica-uploads;
        echo 'MinIO buckets created successfully';
      "
    networks:
      - fabrica-network

  # =============================================================================
  # WORKER - Background Job Processor (optional)
  # =============================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: fabrica-agentes:latest
    container_name: fabrica-worker
    command: ["python", "-m", "factory.core.worker_pool"]
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql://fabrica:${POSTGRES_PASSWORD:-fabrica_db_secret_2024}@postgres:5432/fabrica_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-fabrica_redis_secret}@redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - WORKER_MODE=true
      - MIN_WORKERS=1
      - MAX_WORKERS=2
    volumes:
      - ./projects:/app/projects
      - ./uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - fabrica-network
    profiles:
      - workers  # Only starts with: docker-compose --profile workers up
    labels:
      - "com.fabrica.service=worker"

# =============================================================================
# VOLUMES - Persistent Data
# =============================================================================
volumes:
  postgres_data:
    driver: local
    labels:
      - "com.fabrica.volume=database"
      - "com.fabrica.backup=required"

  redis_data:
    driver: local
    labels:
      - "com.fabrica.volume=cache"

  minio_data:
    driver: local
    labels:
      - "com.fabrica.volume=storage"
      - "com.fabrica.backup=required"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  fabrica-network:
    name: fabrica-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
    labels:
      - "com.fabrica.network=main"
