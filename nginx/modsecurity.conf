# ModSecurity WAF Configuration - Issue #99
# Web Application Firewall for Factory API
# Based on OWASP ModSecurity Core Rule Set (CRS)

# ===========================================
# Core ModSecurity Settings
# ===========================================

# Enable ModSecurity
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling (disabled for performance)
SecResponseBodyAccess Off

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Debug log (set to 0 in production)
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 0

# Temporary files
SecTmpDir /tmp
SecDataDir /tmp

# ===========================================
# OWASP Core Rule Set Includes
# ===========================================

# CRS Setup - customize settings here
Include /etc/nginx/owasp-crs/crs-setup.conf

# CRS Rules
Include /etc/nginx/owasp-crs/rules/REQUEST-901-INITIALIZATION.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-903.9001-DRUPAL-EXCLUSION-RULES.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-903.9002-WORDPRESS-EXCLUSION-RULES.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-905-COMMON-EXCEPTIONS.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-910-IP-REPUTATION.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-911-METHOD-ENFORCEMENT.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-912-DOS-PROTECTION.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-913-SCANNER-DETECTION.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-921-PROTOCOL-ATTACK.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-934-APPLICATION-ATTACK-GENERIC.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf
Include /etc/nginx/owasp-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-950-DATA-LEAKAGES.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-959-BLOCKING-EVALUATION.conf
Include /etc/nginx/owasp-crs/rules/RESPONSE-980-CORRELATION.conf

# ===========================================
# Custom Factory API Rules
# ===========================================

# Rule ID Range: 1000-1999 (custom rules)

# Directory Traversal Protection
SecRule REQUEST_URI "@contains .." \
    "id:1001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Directory traversal attempt',\
    tag:'attack-lfi',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

SecRule REQUEST_URI "@rx (?i)(?:\.\./|\.\.\\\\)" \
    "id:1002,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path traversal attack detected',\
    tag:'attack-lfi',\
    severity:'CRITICAL'"

# SQL Injection Protection
SecRule ARGS "@detectSQLi" \
    "id:1010,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection attack detected in parameters',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

SecRule REQUEST_BODY "@detectSQLi" \
    "id:1011,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection attack detected in request body',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

SecRule ARGS "@rx (?i)(?:union\s+select|select\s+.*\s+from|insert\s+into|update\s+.*\s+set|delete\s+from|drop\s+table|exec\s*\()" \
    "id:1012,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL keyword pattern detected',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# XSS (Cross-Site Scripting) Protection
SecRule ARGS "@detectXSS" \
    "id:1020,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS attack detected in parameters',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL'"

SecRule REQUEST_BODY "@detectXSS" \
    "id:1021,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS attack detected in request body',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

SecRule ARGS "@rx (?i)<script[^>]*>.*?</script>" \
    "id:1022,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Script tag detected in input',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

SecRule ARGS "@rx (?i)(?:javascript:|vbscript:|data:text/html)" \
    "id:1023,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'JavaScript/VBScript URI detected',\
    tag:'attack-xss',\
    severity:'HIGH'"

# Command Injection Protection
SecRule ARGS "@rx (?:;|\||`|\\$\(|\\$\\{)" \
    "id:1030,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Command injection attempt detected',\
    tag:'attack-rce',\
    severity:'CRITICAL'"

SecRule ARGS "@rx (?i)(?:^|[^a-z0-9_])(?:nc|netcat|wget|curl|bash|sh|cmd|powershell)\s" \
    "id:1031,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Shell command detected in input',\
    tag:'attack-rce',\
    severity:'CRITICAL'"

# File Upload Protection
SecRule FILES_NAMES "@rx \.(?:php|phtml|php3|php4|php5|phps|cgi|pl|py|pyc|pyo|jsp|jspx|asp|aspx|exe|dll|bat|cmd|sh|bash)$" \
    "id:1040,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Dangerous file extension upload blocked',\
    tag:'attack-file-upload',\
    severity:'CRITICAL'"

SecRule FILES_TMPNAMES "@rx (?:^|[^a-zA-Z0-9])(?:<%|<\?|<script)" \
    "id:1041,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'File with script content detected',\
    tag:'attack-file-upload',\
    severity:'CRITICAL'"

# HTTP Protocol Attacks
SecRule REQUEST_METHOD "!@rx ^(?:GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)$" \
    "id:1050,\
    phase:1,\
    deny,\
    status:405,\
    log,\
    msg:'Method not allowed',\
    tag:'protocol-violation',\
    severity:'HIGH'"

SecRule REQUEST_HEADERS:Content-Type "@rx (?i)text/plain" \
    "id:1051,\
    phase:1,\
    chain"
    SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH)$" \
        "deny,\
        status:415,\
        log,\
        msg:'Invalid content-type for request body',\
        tag:'protocol-violation',\
        severity:'MEDIUM'"

# Rate Limiting (basic)
SecRule IP:request_count "@gt 100" \
    "id:1060,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded',\
    tag:'rate-limit',\
    severity:'WARNING',\
    expirevar:IP:request_count=60"

SecAction \
    "id:1061,\
    phase:1,\
    nolog,\
    pass,\
    setvar:IP:request_count=+1"

# ===========================================
# API-Specific Rules for Factory
# ===========================================

# Protect sensitive API endpoints
SecRule REQUEST_URI "@beginsWith /api/auth" \
    "id:1100,\
    phase:1,\
    pass,\
    nolog,\
    setvar:tx.auth_endpoint=1"

# Stricter validation for auth endpoints
SecRule TX:auth_endpoint "@eq 1" \
    "id:1101,\
    phase:2,\
    chain"
    SecRule ARGS:password "@rx ^.{0,7}$" \
        "deny,\
        status:400,\
        log,\
        msg:'Password too short',\
        tag:'input-validation',\
        severity:'MEDIUM'"

# Block access to internal endpoints from external
SecRule REQUEST_URI "@rx ^/api/internal" \
    "id:1110,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Access to internal API denied',\
    tag:'access-control',\
    severity:'HIGH'"

# JSON body validation
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
    "id:1120,\
    phase:2,\
    chain"
    SecRule REQUEST_BODY "!@rx ^[\s]*[\[\{]" \
        "deny,\
        status:400,\
        log,\
        msg:'Invalid JSON body',\
        tag:'input-validation',\
        severity:'MEDIUM'"

# ===========================================
# Exclusions for Known Safe Patterns
# ===========================================

# Allow Swagger/OpenAPI documentation
SecRule REQUEST_URI "@rx ^/(?:docs|redoc|openapi\.json)" \
    "id:1200,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=1010-1030"

# Allow health check endpoints
SecRule REQUEST_URI "@rx ^/(?:health|ready|live)" \
    "id:1201,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Allow metrics endpoint from internal
SecRule REQUEST_URI "@beginsWith /metrics" \
    "id:1202,\
    phase:1,\
    chain"
    SecRule REMOTE_ADDR "@ipMatch 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" \
        "pass,\
        nolog,\
        ctl:ruleEngine=Off"

# ===========================================
# Logging and Alerting
# ===========================================

# Log all blocked requests
SecRule TX:ANOMALY_SCORE "@ge 5" \
    "id:1300,\
    phase:5,\
    log,\
    noauditlog,\
    msg:'Anomaly score threshold exceeded: %{TX.ANOMALY_SCORE}',\
    tag:'anomaly-detection',\
    severity:'WARNING'"
