# Plataforma E - Release Workflow
# Issue #51: Integracao CI/CD com GitHub Actions
#
# Cria releases automaticas quando uma tag e criada
# Formato da tag: v*.*.* (ex: v1.0.0, v2.1.3)

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

env:
  DOCKER_IMAGE: fabrica-agentes

jobs:
  # =============================================================================
  # VALIDATE: Verifica a versao e roda os testes
  # =============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-release-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-release-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests
        run: |
          pytest tests/unit/ -v --tb=short
        env:
          PYTHONPATH: .

      - name: Verify imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from factory.dashboard.app_v6_agile import app
          from factory.api.routes import router
          from factory.database.models import Story, Task
          print('All imports validated successfully!')
          "
        env:
          PYTHONPATH: .

  # =============================================================================
  # BUILD: Constroi os artefatos da release
  # =============================================================================
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create release archive
        run: |
          VERSION=${{ needs.validate.outputs.version }}

          # Create dist directory
          mkdir -p dist

          # Create source archive (excluding unnecessary files)
          tar --exclude='.git' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.env' \
              --exclude='*.db' \
              --exclude='projects/' \
              --exclude='uploads/' \
              --exclude='dist/' \
              --exclude='.pytest_cache' \
              --exclude='.mypy_cache' \
              --exclude='.ruff_cache' \
              -czvf dist/fabrica-agentes-${VERSION}.tar.gz .

          # Create requirements bundle
          cp requirements.txt dist/requirements-${VERSION}.txt

          echo "Release artifacts created:"
          ls -la dist/

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/
          retention-days: 30

  # =============================================================================
  # DOCKER: Constroi e publica a imagem Docker
  # =============================================================================
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Uncomment to push to Docker Hub
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #
      # - name: Push Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     push: true
      #     tags: ${{ steps.meta.outputs.tags }}
      #     labels: ${{ steps.meta.outputs.labels }}

  # =============================================================================
  # RELEASE: Cria a release no GitHub
  # =============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build, docker]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.validate.outputs.version }}

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to v$VERSION"
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tag found, generating full changelog"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi

          # Create changelog file
          cat > RELEASE_NOTES.md << EOF
          ## Plataforma E v${VERSION}

          ### What's Changed

          ${COMMITS}

          ### Installation

          \`\`\`bash
          # Clone the repository
          git clone https://github.com/${{ github.repository }}.git
          cd fabrica-agentes

          # Install dependencies
          pip install -r requirements.txt

          # Run the dashboard
          python factory/dashboard/app_v6_agile.py
          \`\`\`

          ### Docker

          \`\`\`bash
          # Build Docker image
          docker build -t fabrica-agentes:${VERSION} .

          # Run container
          docker run -p 9001:9001 fabrica-agentes:${VERSION}
          \`\`\`

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${VERSION}
          EOF

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Plataforma E v${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ inputs.prerelease || false }}
          files: |
            dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "=========================================="
          echo "Release Summary"
          echo "=========================================="
          echo "Version: v${{ needs.validate.outputs.version }}"
          echo "Repository: ${{ github.repository }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate.outputs.version }}"
          echo "=========================================="

  # =============================================================================
  # NOTIFY: Notifica sobre a release (opcional)
  # =============================================================================
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: success()

    steps:
      - name: Release notification
        run: |
          echo "=========================================="
          echo "Release v${{ needs.validate.outputs.version }} created successfully!"
          echo "=========================================="
          echo ""
          echo "Next steps:"
          echo "1. Review the release notes"
          echo "2. Announce the release to the team"
          echo "3. Update documentation if needed"
          echo ""
          # Add webhook notification here if needed
          # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text": "Release v${{ needs.validate.outputs.version }} is now available!"}'
