# Kubernetes Ingress
# Issue #205 - Auto-scaling horizontal
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: factory-ingress
  namespace: fabrica-de-agentes
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - factory.example.com
    secretName: factory-tls
  rules:
  - host: factory.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: factory-api
            port:
              number: 9001
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: factory-api
            port:
              number: 9001
---
# Network Policy - restrict traffic between services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: factory-network-policy
  namespace: fabrica-de-agentes
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: fabrica-de-agentes
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: fabrica-de-agentes
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    ports:
    - protocol: TCP
      port: 443
