# =============================================================================
# Configuracao do Promtail - Fabrica de Agentes
# =============================================================================
# Promtail e o agente que coleta logs e envia para o Loki.
# Esta configuracao coleta logs da aplicacao e de containers Docker.
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: fabrica
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # ==========================================================================
  # Logs da aplicacao Fabrica de Agentes
  # ==========================================================================
  - job_name: fabrica-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: fabrica-agentes
          env: development
          __path__: /var/log/fabrica/*.log

    pipeline_stages:
      # Parseia JSON
      - json:
          expressions:
            level: level
            message: message
            timestamp: "@timestamp"
            module: module
            function: function
            job_id: job_id
            worker_id: worker_id
            agent_id: agent_id
            task_id: task_id
            project_id: project_id
            request_id: request_id
            correlation_id: correlation_id
            duration_ms: duration_ms
            category: category
            event: event

      # Extrai labels
      - labels:
          level:
          module:
          category:
          event:

      # Adiciona labels de contexto
      - labels:
          job_id:
          worker_id:
          agent_id:

      # Define timestamp do log
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.999999999Z07:00"
            - "2006-01-02T15:04:05Z"

      # Define output
      - output:
          source: message

  # ==========================================================================
  # Logs de containers Docker
  # ==========================================================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Filtra apenas containers do projeto
      - source_labels: ['__meta_docker_container_name']
        regex: 'fabrica-.*'
        action: keep

      # Extrai nome do container
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container

      # Extrai nome da imagem
      - source_labels: ['__meta_docker_container_image']
        target_label: image

      # Extrai labels do container
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service

    pipeline_stages:
      # Tenta parsear como JSON
      - json:
          expressions:
            level: level
            message: message
            timestamp: "@timestamp"
          on_error: keep

      # Fallback para regex se nao for JSON
      - regex:
          expression: '^(?P<timestamp>\S+)\s+(?P<level>\w+)\s+(?P<message>.*)$'

      - labels:
          level:

      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.999999999Z07:00"
            - "2006-01-02T15:04:05Z"
            - "2006-01-02 15:04:05"

  # ==========================================================================
  # Logs de erro separados
  # ==========================================================================
  - job_name: fabrica-errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: fabrica-agentes
          type: errors
          __path__: /var/log/fabrica/factory-errors.log

    pipeline_stages:
      - json:
          expressions:
            level: level
            message: message
            timestamp: "@timestamp"
            error_type: 'exception.type'
            error_message: 'exception.message'
            stacktrace: 'exception.stacktrace'

      - labels:
          level:
          error_type:

      - timestamp:
          source: timestamp
          format: RFC3339Nano
