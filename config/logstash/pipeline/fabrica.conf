# =============================================================================
# Pipeline do Logstash - Fabrica de Agentes
# =============================================================================
# Processa logs da aplicacao e envia para o Elasticsearch
# =============================================================================

input {
  # TCP input para receber logs via rede
  tcp {
    port => 5000
    codec => json_lines
    tags => ["tcp"]
  }

  # Beats input (Filebeat)
  beats {
    port => 5044
    tags => ["beats"]
  }

  # HTTP input para API
  http {
    port => 8080
    codec => json
    tags => ["http"]
  }
}

filter {
  # Adiciona timestamp se nao existir
  if ![timestamp] and ![@timestamp] {
    ruby {
      code => "event.set('@timestamp', Time.now)"
    }
  }

  # Parseia timestamp ISO8601
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSSSS", "yyyy-MM-dd HH:mm:ss"]
      target => "@timestamp"
    }
  }

  # Normaliza nivel de log
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # Adiciona campos padrao
  mutate {
    add_field => {
      "app" => "fabrica-agentes"
      "env" => "${ENVIRONMENT:development}"
    }
  }

  # Extrai campos de contexto se existirem
  if [context] {
    ruby {
      code => "
        ctx = event.get('context')
        if ctx.is_a?(Hash)
          ctx.each do |k, v|
            event.set(k, v) unless v.nil?
          end
        end
      "
    }
  }

  # Parseia stacktrace se for erro
  if [level] == "ERROR" or [level] == "CRITICAL" {
    if [exception][stacktrace] {
      mutate {
        add_field => { "has_error" => "true" }
      }
    }
  }

  # Adiciona geoip se tiver IP
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Remove campos internos
  mutate {
    remove_field => ["host", "port", "@version"]
  }
}

output {
  # Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "fabrica-logs-%{+YYYY.MM.dd}"

    # Template para mapping
    template_name => "fabrica-logs"
    template_overwrite => true
    template => "/usr/share/logstash/config/template.json"
  }

  # Debug (descomente para troubleshooting)
  # stdout {
  #   codec => rubydebug
  # }
}
