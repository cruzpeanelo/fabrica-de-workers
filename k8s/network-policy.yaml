# Network Policies - Issue #93
# Implements zero-trust network security for factory pods

---
# Default deny all ingress/egress for factory namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: factory
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# API Pod Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-network-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      app: factory-api
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000

    # Allow health checks from kubelet
    - from:
        - ipBlock:
            cidr: 10.0.0.0/8  # Adjust for your cluster CIDR
      ports:
        - protocol: TCP
          port: 8000

    # Allow metrics scraping from Prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090  # Metrics port

  egress:
    # Allow connection to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432

    # Allow connection to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow connection to workers
    - to:
        - podSelector:
            matchLabels:
              app: factory-worker
      ports:
        - protocol: TCP
          port: 8001

    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow external HTTPS (for Claude API, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# Worker Pod Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: worker-network-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      app: factory-worker
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow traffic from API
    - from:
        - podSelector:
            matchLabels:
              app: factory-api
      ports:
        - protocol: TCP
          port: 8001

    # Allow health checks
    - from:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 8001

  egress:
    # Allow connection to Redis (job queue)
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow connection to PostgreSQL (results storage)
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432

    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow external HTTPS (for Claude API)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# PostgreSQL Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow connections from API and Workers only
    - from:
        - podSelector:
            matchLabels:
              app: factory-api
        - podSelector:
            matchLabels:
              app: factory-worker
      ports:
        - protocol: TCP
          port: 5432

  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# Redis Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-network-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow connections from API and Workers only
    - from:
        - podSelector:
            matchLabels:
              app: factory-api
        - podSelector:
            matchLabels:
              app: factory-worker
      ports:
        - protocol: TCP
          port: 6379

  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# Dashboard Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dashboard-network-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      app: factory-dashboard
  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 9001

  egress:
    # Allow connection to API
    - to:
        - podSelector:
            matchLabels:
              app: factory-api
      ports:
        - protocol: TCP
          port: 8000

    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Vault Access Network Policy (for secrets management)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vault-access-policy
  namespace: factory
spec:
  podSelector:
    matchLabels:
      vault-access: "true"
  policyTypes:
    - Egress

  egress:
    # Allow connection to Vault in vault namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: vault
          podSelector:
            matchLabels:
              app.kubernetes.io/name: vault
      ports:
        - protocol: TCP
          port: 8200
