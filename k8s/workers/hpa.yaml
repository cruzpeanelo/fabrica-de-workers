# =============================================================================
# Plataforma E - Workers HorizontalPodAutoscaler
# =============================================================================
# Auto-scaling para Workers baseado em metricas customizadas (fila de jobs)
#
# Aplicar com: kubectl apply -f workers/hpa.yaml
# =============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: fabrica-worker-hpa
  namespace: fabrica-agentes
  labels:
    app.kubernetes.io/name: fabrica-agentes
    app.kubernetes.io/component: worker
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: fabrica-worker

  # Limites de replicas - Workers tem scaling mais conservador
  minReplicas: 1
  maxReplicas: 5

  metrics:
    # CPU - Workers usam mais CPU durante processamento IA
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60

    # Memoria - Workers podem usar mais memoria
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70

    # Metrica customizada - Tamanho da fila de jobs no Redis
    # NOTA: Requer Prometheus Adapter configurado
    # - type: External
    #   external:
    #     metric:
    #       name: redis_list_length
    #       selector:
    #         matchLabels:
    #           list: "job_queue"
    #     target:
    #       type: AverageValue
    #       averageValue: "10"  # Escalar quando houver mais de 10 jobs por worker

  behavior:
    # Scale Up - Adicionar workers mais rapidamente quando fila cresce
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max

    # Scale Down - Reduzir workers lentamente para nao interromper jobs
    scaleDown:
      stabilizationWindowSeconds: 600  # 10 minutos
      policies:
        - type: Pods
          value: 1
          periodSeconds: 300  # Remover 1 pod a cada 5 minutos
      selectPolicy: Min

---
# =============================================================================
# PodDisruptionBudget para Workers
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: fabrica-worker-pdb
  namespace: fabrica-agentes
  labels:
    app.kubernetes.io/name: fabrica-agentes
    app.kubernetes.io/component: worker
spec:
  # Manter pelo menos 1 worker disponivel
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: fabrica-agentes
      app.kubernetes.io/component: worker

---
# =============================================================================
# Kanban Watcher Deployment (Monitoramento automatico)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fabrica-watcher
  namespace: fabrica-agentes
  labels:
    app.kubernetes.io/name: fabrica-agentes
    app.kubernetes.io/component: watcher
    app.kubernetes.io/version: "6.0"
spec:
  # Apenas 1 watcher por vez (singleton)
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: fabrica-agentes
      app.kubernetes.io/component: watcher
  strategy:
    type: Recreate  # Nao permitir multiplos watchers
  template:
    metadata:
      labels:
        app.kubernetes.io/name: fabrica-agentes
        app.kubernetes.io/component: watcher
        app.kubernetes.io/version: "6.0"
    spec:
      serviceAccountName: fabrica-worker-sa

      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      imagePullSecrets:
        - name: fabrica-registry-credentials

      initContainers:
        - name: wait-for-api
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              until curl -sf http://fabrica-api-service:9001/health; do
                echo "Aguardando API..."
                sleep 5
              done
              echo "API disponivel!"

      containers:
        - name: watcher
          image: fabrica-agentes-watcher:6.0
          imagePullPolicy: Always

          envFrom:
            - configMapRef:
                name: fabrica-agentes-config
            - configMapRef:
                name: fabrica-agentes-urls

          env:
            - name: APP_TYPE
              value: "watcher"
            - name: WATCHER_INTERVAL
              value: "30"
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: fabrica-agentes-secrets
                  key: ANTHROPIC_API_KEY
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: fabrica-agentes-secrets
                  key: DATABASE_URL

          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"

          # Watcher nao expoe porta HTTP, usar exec probe
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "print('alive')"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 3

          volumeMounts:
            - name: projects-data
              mountPath: /app/projects

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

      volumes:
        - name: projects-data
          persistentVolumeClaim:
            claimName: fabrica-projects-pvc

      terminationGracePeriodSeconds: 60
